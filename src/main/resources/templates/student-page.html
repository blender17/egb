<!DOCTYPE HTML>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>

    <title th:text="${student.name}"></title>
    <meta th:name="_csrf" th:content="${_csrf.token}"/>
    <meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&family=Prompt&display=swap" rel="stylesheet">

    <!--               Google charts                     -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!--               JQuery                     -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
<th:block th:insert="fragments/header :: header"/>
<div class="wrapper">
    <div sec:authorize="hasRole('ADMIN')">
        <a th:href="@{/admin/student/{id}/edit (id=${student.studentId})}" class="link-button" style="margin-top: 50px; float: right; margin-right: 10vw">Edit student</a>
        <a th:onclick="'javascript:deleteEntity(\'' + ${student.studentId} + '\',\''+ 'student' + '\');'"
           class="link-button" style="margin-top: 50px; float: right; margin-right: 20px">Delete student</a>
    </div>

    <h1 th:text="${student.name}"></h1>

    <div>
        <div style="float: left;">
            <span style="font-weight: 500;">Birthday:</span>
            <span th:text="${student.birthday} + ' (' + ${student.age} + ' years)' "></span>
            <br>
            <span style="font-weight: 500">Email:</span>
            <a th:href="'mailto:' + ${student.contacts.email}" th:text="${student.contacts.email}"></a>
        </div>

        <div style="float: left; margin-left: 30px">
            <span style="font-weight: 500">Gender:</span>
            <span th:text="${student.gender}"></span>
            <br>
            <span style="font-weight: 500">Phone:</span>
            <span th:text="${student.contacts.phoneNumber}"></span>
        </div>
    </div>

    <div style="clear: both;">
        <div style="float: left">
            <h2>Faculty information</h2>
            <div style="float: left;">
                <span style="font-weight: 500">Class:</span>
                <span th:text="${student.studentClass.classCode}"></span>
                <br>
                <span style="font-weight: 500">Faculty:</span>
                <span th:text="${student.studentClass.faculty}"></span>
                <br>
                <span style="font-weight: 500">Average mark:</span>
                <span th:text="${avgMark}"></span>
            </div>

            <div style="float: left; margin-left: 30px">
                <span style="font-weight: 500">Program:</span>
                <span th:text="${student.studentClass.program}"></span>
                <br>
                <span style="font-weight: 500">Attendance:</span>
                <span th:text="${attendance} + '%'"></span>
            </div>
        </div>

        <div style="float: left; margin-left: 30px">
            <h2>Personal information</h2>
            <div style="float: left;">
                <span style="font-weight: 500">Country:</span>
                <span th:text="${student.contacts.country}"></span>
                <br>
                <span style="font-weight: 500">State:</span>
                <span th:text="${student.contacts.state}"></span>
                <br>
                <span style="font-weight: 500">Address:</span>
                <span th:text="${student.contacts.address}"></span>
                <br>
                <span style="font-weight: 500">ZIP-code:</span>
                <span th:text="${student.contacts.zipCode}"></span>
            </div>

            <div style="float: left; margin-left: 30px">
                <span style="font-weight: 500">Father's name:</span>
                <span th:text="${student.contacts.fatherName}"></span>
                <br>
                <span style="font-weight: 500">Father's phone:</span>
                <span th:text="${student.contacts.fatherPhoneNumber}"></span>
                <br>
                <span style="font-weight: 500">Mother's name:</span>
                <span th:text="${student.contacts.motherName}"></span>
                <br>
                <span style="font-weight: 500">Mother's phone:</span>
                <span th:text="${student.contacts.motherPhoneNumber}"></span>
            </div>
        </div>
    </div>

    <div style="width: 445px; float: left; clear: both">
        <table class="table-card" style="width: 100%">
            <thead>
            <tr>
                <td>Avg. mark by subject</td>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td style="padding: 0">
                    <div id="chart_line"></div>
                </td>
            </tr>
            </tbody>
        </table>

        <table class="subject-card" style="width: 100%; margin-top: 0">
            <thead>
            <tr>
                <td>Subject</td>
                <td>Average mark</td>
            </tr>
            </thead>
            <tbody>
            <tr th:each=" subjectsMark : ${avgMarksBySubject}">
                <td th:text="${subjectsMark.subject}"> </td>
                <!--<td th:text="${subjectsMark.avgMark}" style="text-align: center"> </td>-->
                <td th:text="${#numbers.formatDecimal(subjectsMark.avgMark, 0, 1, 'POINT')}" style="text-align: center"> </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div style="width: 445px; float: left; margin-left: 220px">
        <table class="table-card" style="width: 100%">
            <thead>
            <tr>
                <td>Attendance by month</td>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td style="padding: 0">
                    <div id="chart_col"></div>
                </td>
            </tr>
            </tbody>
        </table>

        <table class="subject-card" style="width: 100%; margin-top: 0">
            <thead>
            <tr>
                <td>Subject</td>
                <td>Attendance</td>
            </tr>
            </thead>
            <tbody>
            <tr th:each=" subjectsAttendance : ${attendanceBySubject}">
                <td th:text="${subjectsAttendance.subject}"> </td>
                <td th:text="${subjectsAttendance.getStatistic() + '%'}" style="text-align: center"> </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<th:block th:insert="fragments/footer :: footer"/>
<script type="text/javascript" th:inline="javascript">

    const col_chart_data = /*[[${monthlyAttendance}]]*/'noValue';

    google.charts.load('current', {packages: ['corechart', 'line']});
    google.charts.setOnLoadCallback(drawBasic);
    google.charts.load('current', {packages: ['corechart', 'bar']});
    google.charts.setOnLoadCallback(drawMaterial);

    function drawMaterial() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Month');
        data.addColumn('number', 'Attendance');

        Object.keys(col_chart_data).forEach(function(key) {
            data.addRow([key, col_chart_data[key]]);
        });

        var options = {
            legend: { position: "none" },
            colors: ['#333333']
        };

        var materialChart = new google.charts.Bar(document.getElementById('chart_col'));
        google.visualization.events.addListener(materialChart, 'select', function () {materialChart.setSelection([]);});
        materialChart.draw(data, options);
    }

    function drawBasic() {
        const line_chart_data = /*[[${avgMarksByMonth}]]*/'noValue';

        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Month');
        data.addColumn('number', 'Mark');

        Object.keys(col_chart_data).forEach(function(key) {
            data.addRow([key, line_chart_data[key]]);
        });

        var options = {
            legend: { position: "none" },
            series: {
                0: {color: '#333333'},
            }
        };

        var chart = new google.visualization.LineChart(document.getElementById('chart_line'));
        google.visualization.events.addListener(chart, 'select', function () {chart.setSelection([]);});

        chart.draw(data, options);
    }

    function deleteStudent(id) {
        const url = '/admin/student/' + id + '/delete';

        let result = confirm("Delete student?");
        if (result) {
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");
            $(document).ajaxSend(function(e, xhr, options) {
                xhr.setRequestHeader(header, token);
            });

            $.ajax({
                url: url,
                type: 'delete',
            });
            location.reload();
        }
    }
</script>
</body>
</html>
